name: Android APK to Google Drive

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "android/**"
      - "package.json"
      - "package-lock.json"
      - "angular.json"
      - "capacitor.config.ts"
      - ".github/workflows/android-apk-to-drive.yml"

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      GDRIVE_FOLDER_LINK: ${{ secrets.GDRIVE_FOLDER_LINK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install frontend deps
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor Android project
        run: npx cap sync android

      - name: Build debug APK
        working-directory: android
        run: ./gradlew assembleDebug

      - name: Keep APK as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error

      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Upload APK to Google Drive folder
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${GDRIVE_SERVICE_ACCOUNT_JSON:-}" ]; then
            echo "Missing secret: GDRIVE_SERVICE_ACCOUNT_JSON"
            exit 1
          fi

          folder_input="${GDRIVE_FOLDER_ID:-${GDRIVE_FOLDER_LINK:-}}"
          if [ -z "${folder_input}" ]; then
            echo "Set either GDRIVE_FOLDER_ID or GDRIVE_FOLDER_LINK secret."
            exit 1
          fi

          # Accept raw folder ID or full folder URL.
          folder_id="$folder_input"
          if [[ "$folder_input" == *"/folders/"* ]]; then
            folder_id="${folder_input#*/folders/}"
            folder_id="${folder_id%%[\?&]*}"
            folder_id="${folder_id%%/*}"
          elif [[ "$folder_input" == *"id="* ]]; then
            folder_id="${folder_input#*id=}"
            folder_id="${folder_id%%&*}"
          fi

          mkdir -p "$HOME/.config/rclone"
          printf '%s' "$GDRIVE_SERVICE_ACCOUNT_JSON" > "$RUNNER_TEMP/gdrive-sa.json"
          cat > "$HOME/.config/rclone/rclone.conf" <<EOF
          [gdrive]
          type = drive
          scope = drive
          service_account_file = $RUNNER_TEMP/gdrive-sa.json
          EOF

          apk_path="android/app/build/outputs/apk/debug/app-debug.apk"
          apk_name="aurofly-debug-${GITHUB_RUN_NUMBER}-${GITHUB_SHA::7}.apk"

          rclone copyto "$apk_path" "gdrive:${apk_name}" --drive-root-folder-id "$folder_id"
          echo "Uploaded: ${apk_name}"

          # Optional: print a share link if Drive permissions allow link creation.
          set +e
          link="$(rclone link "gdrive:${apk_name}" --drive-root-folder-id "$folder_id" 2>/dev/null)"
          set -e
          if [ -n "${link}" ]; then
            echo "Drive link: ${link}"
          else
            echo "Upload done. File is in Drive folder ID: ${folder_id}"
          fi
